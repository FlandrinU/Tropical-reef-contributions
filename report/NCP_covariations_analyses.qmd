---
title: "NCP's covariations analyses"
author: "Ulysse Flandrin"
date: "`r Sys.Date()`"
format: 
  html:
    self-contained: true
    code-fold: true
    theme: cosmo 
    toc: true
    number-sections: true
    toc-location: left
    html-math-method: katex
    css: styles.css

# execute: 
#   echo: false
---

------------------------------------------------------------------------

# Introduction  

-   **Questions:**
    -   Can we classify the reefs according to their ability to supply one or a kind of NCP ?
    -   Where are the reefs good for Nature conservation? and for Society well-being ?
    -   Which trade offs have we got between NCPs?
    -   Are there specialized reefs in one or few kinds of NCPs?
    -   Are there reefs good or bad for alls NCP (brightspots/darkspots),
    -   ...?
-   **Hypothesis:**
    -   There are many trade offs between NCPs, i.e reefs can't be of great interest for all NCPS in the same time? and neither bad for all?
    -   reefs interesting for Nature are my not the same than those valuable for societies?

*NB: We use to talk about "Nature Contributions to People", it seems better than "ecosystem services", but Humans are still the center of the Nature contributions... Perhaps something like "Nature Based Contributions" could be more neutral? This would include Nature for Nature (NN), and Nature for Society  services (NS)...? The human well-being may be then a result of Nature to Society services and a healthy Nature as our mind is influenced by the surrounding world. In the IPBES classification, NS could be synonym of "Nature Contributions to People" and NN could reflect intrinsic value of Nature... *

------------------------------------------------------------------------


```{r}
#| label: import_data
#| warning: false
#| message: false

#-----------------Loading packages-------------------
pkgs <- c("here", "tidyverse","FactoMineR", "tibble", "questionr", "corrplot",
          "factoextra", "ggpubr", "scico", "RColorBrewer", "plotly", "fishualize", 
          "ggplot2", "patchwork", "colormap", "grDevices", "ggnewscale", "sf",
          "rdacca.hp")
nip <- pkgs[!(pkgs %in% installed.packages())]
nip <- lapply(nip, install.packages, dependencies = TRUE)
ip   <- unlist(lapply(pkgs, require, character.only = TRUE, quietly = TRUE))

rm(list=ls())

##-------------loading data-------------
load(here::here("outputs","all_NCP_site.Rdata"))
#load(here::here("outputs","all_NCP_surveys.Rdata"))
#benthic_imputed <- read.csv(here::here("data_raw", "source", "RLS_benthic_imputed.txt"), sep= " ")
load(here::here("biodiversity", "outputs", "occurrence_matrix_family_survey_relative_biomass.Rdata"))
load(here::here("data","metadata_surveys.Rdata"))

##-------------computing pca-------------
rownames(NCP_site) <- NCP_site$SiteCode
NCP_site_for_pca <- subset(NCP_site, select = -c(SiteCode, SiteCountry, SiteEcoregion, SurveyDepth, 
                                                 SiteMeanSST, SiteLatitude, SiteLongitude, Btot,
                                                 HDI, gravtot2, MarineEcosystemDependency,
                                                 coral_imputation))
                                                 #fishery_biomass, biom_lowTL, biom_mediumTL, biom_highTL))
pca <- FactoMineR::PCA(NCP_site_for_pca, scale.unit = T, graph=F, ncp=10)
```

-   **See data:**

    -   *Structure of the data:*

```{r}
#| label: see data

glimpse(NCP_site_for_pca)
summary(NCP_site$SiteCountry)
```

------------------------------------------------------------------------

# Vizualize services assessement  
## Biomass on maps  
::: {layout="[[1], [1], [1]]"}
![](`r here::here("outputs", "figures", "NCP_on_world_map", "world_map_with_Btot.jpg") `)

![](`r here::here("outputs", "figures", "NCP_on_world_map", "Australian_map_with_Btot.jpg") `)

![](`r here::here("outputs", "figures", "NCP_on_world_map", "Caraib_map_with_Btot.jpg") `)
:::

## NCPs distributions  
### Original data  
![](`r here::here("outputs", "figures", "NCP_distribution.png") `){width=100%}

### log transformed data  
![](`r here::here("outputs", "figures", "NCP_log_transformed_distribution.png") `){width=100%} 


## Correlations between NCPs  
### With Biomass  
![Correlation between NCP and Biomass](`r here::here("outputs", "figures", "NCP_correlation_with_biomass.png") `){width=100%}  

### With biodiversity  
![Correlation between NCP and Biodiversity](`r here::here("outputs", "figures", "NCP_correlation_with_biodiversity.png") `){width=100%}  

### Corr-matrix for all NCPs  
![Correlation between NCPs](`r here::here("outputs", "figures", "corr_matrix.png") `){width=100%}  

### Corr-matrix for log transformed NCPs  
![Correlation between NCPs](`r here::here("outputs", "figures", "corr_matrix_log_transformed_NCP.png") `){width=100%}  

------------------------------------------------------------------------

# PCA with log transformed data

## PCA with all NCPs at the community scale

### Number of dimensions

#### Variance explained by the 15 first dimensions  


:::{#fig-explained_variance layout-ncol=2}

![Dimension Eigenvalues](`r here::here("outputs", "figures", "barplot_variance_explained_all_NCP.png") `)

![](`r here::here("outputs", "figures", "barplot_cumulative_variance_explained_all_NCP.png") `)

Variance explained by ACP dimensions
:::

#### Contribution of NCP in dimensions  
![Corrplot of NCP contributions in dimensions ](`r here::here("outputs", "figures", "contribution_NCP_in_dimensions.png") `){width=80%}  

### Variables in PCA  
#### PCA in the 2 first dimensions  
![PCA in the 2 first dimensions, with representation quality ($cos^{2}$) of each variables](`r here::here("outputs", "figures", "PCA_all_NCP.png") `){width=100%}  

> *Display only well represented variables (cos2 \> 0.4):*  

![PCA in the 2 first dimensions, with well represented variables: ($cos^{2}$) > 0.4](`r here::here("outputs", "figures", "PCA_all_NCP_cos2_0.4.png") `){width=70%} 

> *Classify variables in Nature for Nature (NN) and Nature for Society (NS)*

```{r}
var <- get_pca_var(pca)
grp <- c(recycling_N="NN", recycling_P="NN",Productivity="NS",taxo_richness="NN", funct_entropy="NN",         
         funct_distinctiveness="NN", Selenium_C="NS", Zinc_C="NS", Omega_3_C="NS", Calcium_C="NS",
         Iron_C="NS", Vitamin_A_C="NS", phylo_entropy="NN", ED_Mean="NN", aesthe_survey="NS", iucn_species="NN",
         elasmobranch_diversity="NN", low_mg_calcite="NN", high_mg_calcite="NN", aragonite="NN", 
         monohydrocalcite="NN", amorphous_carbonate="NN", biom_lowTL="NN", biom_mediumTL="NN",
         biom_highTL="NN", fishery_biomass="NS") # /!\ the order matter
```
![PCA classified in NN and NS variables](`r here::here("outputs", "figures", "PCA_NS_NN_axes1-2.png") `){width=100%} 

#### PCA in dimensions 3 and 4 *(for variables with cos2 \> 0.2, and according the NCPs groups)*

:::{#fig-PCA_in_other_dimensions layout-ncol=2}

![PCA in dimensions 3 & 4, classified by NN and NS](`r here::here("outputs", "figures", "PCA_NS_NN_axes3-4.png") `)

![PCA in dimensions 5 & 6, with ($cos^{2}$) > 0.4](`r here::here("outputs", "figures", "PCA_cos2_0.2_axes5-6.png") `)

PCA in next dimensions
:::



## Categories as Diaz 2022

-> See table with categories in Christie 2019 : Material, Regulating, Non-material. + IPBES focus on the intrinsic value of Nature.

### Dimensions 1 and 2  
```{r}
var_3cat <- get_pca_var(pca)
grp_3cat <- c(recycling_N="regulating", recycling_P="regulating",Productivity="material",taxo_richness="nature", funct_entropy="regulating", funct_distinctiveness="nature", Selenium_C="material", Zinc_C="material", Omega_3_C="material", Calcium_C="material",Iron_C="material", Vitamin_A_C="material", phylo_entropy="regulating", ED_Mean="nature", aesthe_survey="non material", iucn_species="nature", elasmobranch_diversity="nature", low_mg_calcite="regulating", high_mg_calcite="regulating", aragonite="regulating", monohydrocalcite="regulating", amorphous_carbonate="regulating", biom_lowTL="regulating", biom_mediumTL="regulating", biom_highTL="regulating", fishery_biomass="material") 

```

:::{#fig-Diaz_categories layout-nrow=2}
![Dimensions 1 & 2](`r here::here("outputs", "figures", "PCA_Diaz_categories.png") `){width=100%}

![Dimensions 3 & 4](`r here::here("outputs", "figures", "PCA_Diaz_categories_dim3-4.png") `){width=70%}

All variables classified as IPBES categories
:::

### study categories separately  

#### Regulating NCP

![](`r here::here("outputs", "figures", "PCA_regulating_NCP.png") `)

#### material NCP

![](`r here::here("outputs", "figures", "PCA_material_NCP.png") `)

#### Nature intrinsic value

![](`r here::here("outputs", "figures", "PCA_nature_Diaz_NCP.png") `)




## Sites distribution


### By countries

![Sites distributions, with ($cos^{2}$) > 0.4 variables](`r here::here("outputs", "figures", "PCA_countries_cos2_0.4.png") `)


### Temperature pattern

:::{#fig-temperature layout-nrow=2}
![Temperature pattern in PCA](`r here::here("outputs", "figures", "PCA_temperature_pattern.png") `)

![Temperature according to Dimension 2](`r here::here("outputs", "figures", "PCA_temp_according_Dim2.png") `)

Temperature pattern in PCA
:::

 *=> Strong temperature pattern, notably due to Spain with high omega 3 richness*



### Gravity pattern:  log10(gravtot2)

![Gravity pattern in PCA](`r here::here("outputs", "figures", "PCA_gravity_pattern.png") `)

### Country HDI

![HDI pattern in PCA](`r here::here("outputs", "figures", "PCA_HDI_pattern.png") `)

### Marine Ecosystem Dependency

![MED pattern in PCA](`r here::here("outputs", "figures", "PCA_MED_pattern.png") `)

### Imputed coral cover

![coral cover pattern in PCA](`r here::here("outputs", "figures", "PCA_coral_cover_pattern.png") `)

### Depth pattern

![depth pattern in PCA](`r here::here("outputs", "figures", "PCA_depth_pattern.png") `)

### Lattitude pattern

![lattitude pattern in PCA](`r here::here("outputs", "figures", "PCA_lattitude_pattern.png") `)




## Study NN and NS separately

### Nature contributions to Nature   
    -> covariation between Nature for Nature NCPs only

![](`r here::here("outputs", "figures", "barplot_variance_explained_by_NN.png") `)

![](`r here::here("outputs", "figures", "contribution_NN_in_dimensions.png") `)


#### NN variations in the 2 first dimensions  

![](`r here::here("outputs", "figures", "PCA_NN_only.png") `)

![](`r here::here("outputs", "figures", "PCA_countries_NN_only.png") `)

#### NN PCA in dimensions 3 and 4 *(for variables with cos2 \> 0.1)*

      -> to do: save this plot

#### Surveys positions in PC1

![](`r here::here("outputs", "figures", "hist_NN_in_PC1.png") `)

### Nature contributions to Society

![](`r here::here("outputs", "figures", "barplot_variance_explained_by_NS.png") `)

![](`r here::here("outputs", "figures", "contribution_NS_in_dimensions.png") `)


#### Nature for Society variations in the 2 first dimensions 

![](`r here::here("outputs", "figures", "PCA_NS_only.png") `)

#### NS PCA in dimensions 3 and 4 *(for variables with cos2 \> 0.1)*

![](`r here::here("outputs", "figures", "PCA_NS_only_dim3&4.png") `)

#### Surveys positions in PC1

![](`r here::here("outputs", "figures", "hist_NS_in_PC1.png") `)

## NN and NS scores according to PC1 of both PCAs

![](`r here::here("outputs", "figures", "Sites in NN and NS PC1.jpg") `)

### Plot on map

#### NS according to NN

![](`r here::here("outputs", "figures", "world map with NN and NS PC1.jpg") `)

#### NN worldwide

![](`r here::here("outputs", "figures", "world map with NN PC1.jpg") `)

#### NS worldwide

![](`r here::here("outputs", "figures", "world map with NS PC1.jpg") `)


## Sum up about PCAs

We struggle with dimension reduction in the PCA. It seems that NN and NS services are highly dimensional: around 5 or 6 dimensions are needed to consider all variations in NCPs.
Separated studies of NN and NS help us to say that NN services are quite positively correlated, with notably a strong correlation with the total biomass in PC1 (but also totally separated axes like richness in iucn species). On the other hand, NS are less correlated, which means that trade offs in NS are inevitable...?


# Estimating NN and NS scores with weighted means

We used the Estimator in Dependant Sample method (Kark 2002), to make a weighted mean of NN and NS: 

$$
EDS_{abs} = \frac{\mathrm 1}{\mathrm S_{i=1}^N} . \mathrm S_{i=1}^N (\mathrm a_i . w_{i}^{abs})
\\  
\text{with: } \mathrm w_{i}^{abs} =  \frac{1}{2} + \mathrm S_{j=1}^N(1 -\frac{\mathrm |r_{ij}| }{2})
\\
$$

$$
\text{!! les valeurs de NCPs (} \ \mathrm a_i \ \text{) sont} \ log10() \ \text{(pour les distribution right skewed), et toutes centrées réduites}
$$

## NN and NS scores

:::{#fig-temperature layout-ncol=2}
![](`r here::here("outputs", "figures", "hist_NN_weighted_mean.png") `)

![](`r here::here("outputs", "figures", "hist_NS_weighted_mean.png") `)

NN and NS scores estimated by weighted mean
:::

### NN on map  
![](`r here::here("outputs", "figures", "world map with NN score.jpg") `)

### NS on map  
![](`r here::here("outputs", "figures", "world map with NS score.jpg") `)

## Study NN according to NS  
### Color scales
![](`r here::here("outputs", "figures", "Sites in NN and NS scores.jpg") `)  
*Red color indicates conflict between NN and NS management strategies as both have high score*  

### on map
::: {layout-nrow=3}
![](`r here::here("outputs", "figures", "world map with NN and NS score.jpg") `)  

![](`r here::here("outputs", "figures", "caraïbe map with NN and NS score.jpg") `)  

![](`r here::here("outputs", "figures", "australia map with NN and NS score.jpg") `)  
:::


# Can we infer the scores?  
## Correlation with families  
![Family distributions](`r here::here("outputs", "figures", "families_distribution.png") `)  

### family richness
![According to NN score](`r here::here("outputs", "figures", "families_richness_according_to_NN_score.png") `)  

![According to NS score](`r here::here("outputs", "figures", "families_richness_according_to_NS_score.png") `)  

### family relative biomass
![According to NN score](`r here::here("outputs", "figures", "families_pbiom_according_to_NN_score.png") `)  

![According to NS score](`r here::here("outputs", "figures", "families_pbiom_according_to_NS_score.png") `)  





# Paper outlines  
*__Guidelines People and Nature: __*  

  + *Length:*  
"We do not impose strict length restrictions on submissions to People and Nature. In general Research articles will tend to be around __8000 words__."
  + *Abstract:*  
"The abstract must not exceed __350 words__ and should list the main results and conclusions, using simple, factual, numbered statements. The abstract should outline the purpose of the paper and the main results, conclusions and recommendations, using clear, factual, numbered statements.
__Authors should follow a formula__ in which point __1__ sets the context and need for the work; point __2__ indicates the approach and methods used; the next __2-3__ points outline the main results; and the last point identifies the wider implications and relevance to management or policy. The final point is the most important of all in maximising the impact of the paper. It should synthesise the paper's key messages and should be generic, seminal and accessible to non-specialists, and must carry one of the following subheadings:
'Synthesis and applications' for articles that identify recommendations for management practices.
‘Policy implications’ for articles that are less directly tied to on-the-ground management and include discussion on conservation implications or links to policy."

  + *Keywords:*  
"A list in alphabetical order not exceeding __eight words__ or short phrases."

  + *Introduction:*  
"This should state the reason for doing the work, the nature of the hypothesis or hypotheses under consideration, and should outline the essential background."

  + *Materials and methods:*  
"All data, program code, methods and research materials should be appropriately cited. Where specific equipment and materials are named, the manufacturer’s details (name, city and country) should be given so that readers can trace specifications by contacting the manufacturer. Where commercially available software has been used, details of the supplier should be given in brackets or the reference given in full in the reference list. Do not describe or refer to commonplace statistical tests in this section but allude to them briefly in Results."

  + *Results:*  
__No rules?__ max 6-7 figures in the 10 last published papers in conservation research, __usually 3-5 figures (+1-3 tables) ?__

  + *Discussion:*  


## Introduction  

## M&M

## Results
1. Multidimensionalité des contributions (surtout pour NS), covariations et independance
ACP: __Fig 1__  

Scores NN et NS (pannel en 3 niveaux: les 2 histogrammes de NN et NS avec gradients de couleurs, Cartes monde NN et NS): __Fig 2__

2. Explication des scores: relation avec les familles? DAG avec les variables socio-envir ? __Fig 3?__

3. Compromis de NN et NS: les cadrans et une carte mondiale +/- zoom ? __Fig 4__

## Discussion  
=> notion de compromis, gestion multi objectifs (on peut pas tout faire avec une même AMP)

=> imp du contexte ou familles?

=> un peu de tout partout, vert à protéger, bleu pour gestion de pêche durable, rouge à adapter en fonction des besoins des pops locales (floride -> protection)