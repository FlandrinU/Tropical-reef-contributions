---
title: "NCP's covariations analyses"
author: "Ulysse Flandrin"
format: 
  html:
    self-contained: true
    code-fold: true
    theme: cosmo 
    toc: true
    number-sections: true
    toc-location: left
    html-math-method: katex
    css: styles.css

# execute: 
#   echo: false
---

------------------------------------------------------------------------

# Introduction  

-   **Questions:**
    -   Can we classify the reefs according to their ability to supply one or a kind of NCP ?
    -   Where are the reefs good for Nature conservation? and for Society well-being ?
    -   Which trade offs have we got between NCPs?
    -   Are there specialized reefs in one or few kinds of NCPs?
    -   Are there reefs good or bad for alls NCP (brightspots/darkspots),
    -   ...?
-   **Hypothesis:**
    -   There are many trade offs between NCPs, i.e reefs can't be of great interest for all NCPS in the same time?
    -   reefs interesting for Nature are my not the same than those valuable for societies?

*NB: We use to talk about "Nature Contributions to People", I think this is better than "ecosystem services", but Humans are still the center of the Nature contributions... Perhaps something like "Nature Based Contributions" could be more neutral? This would include Nature for Nature, Nature for society and Nature for Culture services...? The human well-being may be then a result of Nature to People services and a healthy Nature as our mind is influenced by the surrounding world *

------------------------------------------------------------------------


```{r}
#| label: import_data
#| warning: false
#| message: false

#-----------------Loading packages-------------------
pkgs <- c("here", "tidyverse","FactoMineR", "tibble", "questionr", "corrplot",
          "factoextra", "ggpubr", "scico", "RColorBrewer", "plotly", "fishualize", 
          "ggplot2", "patchwork", "colormap", "grDevices", "ggnewscale", "sf",
          "rdacca.hp")
nip <- pkgs[!(pkgs %in% installed.packages())]
nip <- lapply(nip, install.packages, dependencies = TRUE)
ip   <- unlist(lapply(pkgs, require, character.only = TRUE, quietly = TRUE))

rm(list=ls())

##-------------loading data-------------
load(here::here("outputs","all_NCP_site.Rdata"))
#load(here::here("outputs","all_NCP_surveys.Rdata"))
#benthic_imputed <- read.csv(here::here("data_raw", "source", "RLS_benthic_imputed.txt"), sep= " ")
load(here::here("biodiversity", "outputs", "occurrence_matrix_family_survey_relative_biomass.Rdata"))
load(here::here("data","metadata_surveys.Rdata"))

##-------------computing pca-------------
rownames(NCP_site) <- NCP_site$SiteCode
NCP_site_for_pca <- subset(NCP_site, select = -c(SiteCode, SiteCountry, SiteEcoregion, SurveyDepth, 
                                                 SiteMeanSST, SiteLatitude, SiteLongitude, Btot,
                                                 HDI, gravtot2, MarineEcosystemDependency,
                                                 coral_imputation))
                                                 #fishery_biomass, biom_lowTL, biom_mediumTL, biom_highTL))
pca <- FactoMineR::PCA(NCP_site_for_pca, scale.unit = T, graph=F, ncp=10)
```

-   **See data:**

    -   *Structure of the data:*

```{r}
#| label: see data

glimpse(NCP_site_for_pca)
summary(NCP_site$SiteCountry)
```

------------------------------------------------------------------------

# Correlations between NCPs

## With Biomass  
![Correlation between NCP and Biomass](`r here::here("outputs", "figures", "NCP_correlation_with_biomass.png") `){width=100%}  

## With biodiversity  
![Correlation between NCP and Biodiversity](`r here::here("outputs", "figures", "NCP_correlation_with_biodiversity.png") `){width=100%}  

## NCPs distributions  
![](`r here::here("outputs", "figures", "NCP_distribution.png") `){width=100%}  

#### Corr-matrix for all NCPs  
![Correlation between NCPs](`r here::here("outputs", "figures", "corr_matrix.png") `){width=100%}  

------------------------------------------------------------------------

# PCA


## PCA with all NCPs at the community scale


### Number of dimensions

#### Variance explained by the 15 first dimensions  


:::{#fig-explained_variance layout-ncol=2}

![Dimension Eigenvalues](`r here::here("outputs", "figures", "barplot_variance_explained_all_NCP.png") `)

![](`r here::here("outputs", "figures", "barplot_cumulative_variance_explained_all_NCP.png") `)

Variance explained by ACP dimensions
:::

#### Contribution of NCP in dimensions  
![Corrplot of NCP contributions in dimensions ](`r here::here("outputs", "figures", "contribution_NCP_in_dimensions.png") `){width=80%}  

### Variables in PCA  
#### PCA in the 2 first dimensions  
![PCA in the 2 first dimensions, with representation quality ($cos^{2}$) of each variables](`r here::here("outputs", "figures", "PCA_all_NCP.png") `){width=100%}  

> *Display only well represented variables (cos2 \> 0.4):*  

![PCA in the 2 first dimensions, with well represented variables: ($cos^{2}$) > 0.4](`r here::here("outputs", "figures", "PCA_all_NCP_cos2_0.4.png") `){width=70%} 

> *Classify variables in Nature for Nature (NN) and Nature for Society (NS)*

```{r}
var <- get_pca_var(pca)
grp <- c(recycling_N="NN", recycling_P="NN",Productivity="NS",taxo_richness="NN", funct_entropy="NN",         
         funct_distinctiveness="NN", Selenium_C="NS", Zinc_C="NS", Omega_3_C="NS", Calcium_C="NS",
         Iron_C="NS", Vitamin_A_C="NS", phylo_entropy="NN", ED_Mean="NN", aesthe_survey="NS", iucn_species="NN",
         elasmobranch_diversity="NN", low_mg_calcite="NN", high_mg_calcite="NN", aragonite="NN", 
         monohydrocalcite="NN", amorphous_carbonate="NN", biom_lowTL="NN", biom_mediumTL="NN",
         biom_highTL="NN", fishery_biomass="NS") # /!\ the order matter
```
![PCA classified in NN and NS variables](`r here::here("outputs", "figures", "PCA_NS_NN_axes1-2.png") `){width=100%} 

#### PCA in dimensions 3 and 4 *(for variables with cos2 \> 0.2, and according the NCPs groups)*

:::{#fig-PCA_in_other_dimensions layout-ncol=2}

![PCA in dimensions 3 & 4, classified by NN and NS](`r here::here("outputs", "figures", "PCA_NS_NN_axes3-4.png") `)

![PCA in dimensions 5 & 6, with ($cos^{2}$) > 0.4](`r here::here("outputs", "figures", "PCA_cos2_0.2_axes5-6.png") `)

PCA in next dimensions
:::



## Categories as Diaz 2022

-> See table with categories in Christie 2019 : Material, Regulating, Non-material. + IPBES focus on the intrinsic value of Nature.

### Dimensions 1 and 2  
```{r}
var_3cat <- get_pca_var(pca)
grp_3cat <- c(recycling_N="regulating", recycling_P="regulating",Productivity="material",taxo_richness="nature", funct_entropy="regulating", funct_distinctiveness="nature", Selenium_C="material", Zinc_C="material", Omega_3_C="material", Calcium_C="material",Iron_C="material", Vitamin_A_C="material", phylo_entropy="regulating", ED_Mean="nature", aesthe_survey="non material", iucn_species="nature", elasmobranch_diversity="nature", low_mg_calcite="regulating", high_mg_calcite="regulating", aragonite="regulating", monohydrocalcite="regulating", amorphous_carbonate="regulating", biom_lowTL="regulating", biom_mediumTL="regulating", biom_highTL="regulating", fishery_biomass="material") 

```

:::{#fig-Diaz_categories layout-nrow=2}
![Dimensions 1 & 2](`r here::here("outputs", "figures", "PCA_Diaz_categories.png") `){width=100%}

![Dimensions 3 & 4](`r here::here("outputs", "figures", "PCA_Diaz_categories_dim3-4.png") `){width=70%}

All variables classified as IPBES categories
:::

### study categories separately  

#### Regulating NCP

![](`r here::here("outputs", "figures", "PCA_regulating_NCP.png") `)

#### material NCP

![](`r here::here("outputs", "figures", "PCA_material_NCP.png") `)

#### Nature intrinsic value

![](`r here::here("outputs", "figures", "PCA_nature_Diaz_NCP.png") `)




## Sites distribution


### By countries

![Sites distributions, with ($cos^{2}$) > 0.4 variables](`r here::here("outputs", "figures", "PCA_countries_cos2_0.4.png") `)


### Temperature pattern

:::{#fig-temperature layout-nrow=2}
![Temperature pattern in PCA](`r here::here("outputs", "figures", "PCA_temperature_pattern.png") `)

![Temperature according to Dimension 2](`r here::here("outputs", "figures", "PCA_temp_according_Dim2.png") `)

Temperature pattern in PCA
:::

 *=> Strong temperature pattern, notably due to Spain with high omega 3 richness*



### Gravity pattern:  log10(gravtot2)

![Gravity pattern in PCA](`r here::here("outputs", "figures", "PCA_gravity_pattern.png") `)

### Country HDI

![HDI pattern in PCA](`r here::here("outputs", "figures", "PCA_HDI_pattern.png") `)

### Marine Ecosystem Dependency

![MED pattern in PCA](`r here::here("outputs", "figures", "PCA_MED_pattern.png") `)

### Imputed coral cover

```{r, echo=FALSE, fig.width= 8, fig.height=5, message= FALSE}
fviz_pca_biplot(pca,
                axes= c(1,2),
                select.var = list(cos2 = 0.4),
                geom="point", pointshape=21,
                fill.ind = NCP_site$coral_imputation,
                col.ind = NCP_site$coral_imputation,
                gradient.cols = rev(grDevices::colorRampPalette(c("darkred", "white", "forestgreen"))(10)),
                col.var = "black", repel = TRUE,
                invisible= "var",
                legend.title = "Imputed coral cover")
```

### Depth pattern

```{r, echo=FALSE, fig.width= 8, fig.height=5}
fviz_pca_biplot(pca,
                geom="point", pointshape=21,
                fill.ind = NCP_site$SurveyDepth,
                col.ind = NCP_site$SurveyDepth,
                gradient.cols = brewer.pal(10,name="RdYlBu"),
                col.var = "black", repel = TRUE,
                legend.title = "Mean depth")
```

### Lattitude pattern

```{r, echo=FALSE, fig.width= 8, fig.height=5}
fviz_pca_biplot(pca,
                geom="point", pointshape=21,
                fill.ind = abs(NCP_site$SiteLatitude),
                col.ind = abs(NCP_site$SiteLatitude),
                gradient.cols = brewer.pal(10,name="RdYlBu"),
                col.var = "black", repel = TRUE,
                legend.title = "abs(latitude)")
```

```{r, echo= FALSE, eval= FALSE, warning=FALSE}
ind.p <- fviz_pca_ind(pca, geom = "point",
                      pointshape=21,
                      fill.ind = NCP_site$SiteEcoregion)
ggpubr::ggpar(ind.p,
              title = "Principal Component Analysis of NCPs",
              subtitle = "RLS data set",
              caption = "Source: factoextra",
              xlab = "PC1", ylab = "PC2",
              legend.title = "Ecoregion", legend.position = "top",
              ggtheme = theme_gray(), palette = scico(58, palette = "roma")
)

```

```{r, eval=FALSE, echo=FALSE}
#"biplot sites_NCP with Elipse by ecoregion.png"
fviz_pca_biplot (pca,
                 geom="point", pointshape=21,
                 col.ind = NCP_site$SiteEcoregion,
                 fill.ind = NCP_site$SiteEcoregion,
                 palette = scico(58, palette = "roma"),
                 addEllipses = T, label = "var",
                 col.var = "black", repel = TRUE,
                 legend.title = "Ecoregion")
```

### Explore with plotly

```{r, warning=FALSE, echo = FALSE}
library(plotly)
site_coord_in_pca <- as.data.frame(pca$ind$coord) %>%
  cbind(NCP_site[,c("SiteCountry", "SiteMeanSST", "gravtot2")])

plot_ly(site_coord_in_pca,
        x= ~Dim.1, y= ~Dim.2, z= ~Dim.3,
        size = 10
        ) %>%
  add_markers(color= ~SiteCountry)
```

```{r, echo= FALSE}
plot_ly(site_coord_in_pca,
        x= ~Dim.1, y= ~Dim.2, z= ~Dim.3,
        size = 10
        ) %>%
  add_markers(color= ~SiteMeanSST)

plot_ly(site_coord_in_pca,
        x= ~Dim.1, y= ~Dim.2, z= ~Dim.3,
        size = 10
        ) %>%
  add_markers(color= ~log(gravtot2))
```

## Study NN and NS separately

### Nature contributions to Nature   
    -> covariation between Nature for Nature NCPs only

```{r, echo= FALSE, warning=FALSE}
NN <- names(grp)[ grp=="NN" ]
NCP_NN <- NCP_site[,NN]
rownames(NCP_NN) <- rownames(NCP_site)

pca <- FactoMineR::PCA(NCP_NN, scale.unit = T, graph=F, ncp=10)

factoextra::fviz_eig(pca, addlabels = TRUE, ylim = c(0, 35), barfill = "forestgreen", barcolor = "forestgreen")

var <- get_pca_var(pca)
corrplot(var$contrib, is.corr=FALSE)
```

#### NN variations in the 2 first dimensions  

```{r, echo=FALSE, fig.height=10, fig.width=10}
fviz_pca_var(pca, col.var = "forestgreen",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE
)


fviz_pca_biplot (pca,
                 select.var = list(cos2 = 0.1),
                 geom="point", pointshape=21,
                 col.ind = "black",
                 fill.ind = NCP_site$SiteCountry,
                 palette = scico(38, palette = "roma"),
                 addEllipses = F, label = "var",
                 col.var = "black", repel = TRUE,
                 legend.title = "Country",
                 font.legend = c(6, "plain", "black")
                 )

```

#### NN PCA in dimensions 3 and 4 *(for variables with cos2 \> 0.1)*

```{r, echo=FALSE, fig.height=7, fig.width=7}
fviz_pca_var(pca, col.var = "cos2",
             axe=c(3,4),
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE,
             select.var = list(cos2 = 0.1)
)
```

#### Surveys positions in PC1

```{r}
NN_PC1_surveys <- pca$ind$coord[,1]
summary(NN_PC1_surveys)
```

```{r, echo=FALSE, warning=FALSE}
NN_PC1_surveys <- data.frame(NN_PC1=NN_PC1_surveys)
rownames(NN_PC1_surveys) <- rownames(NCP_site)

## NN
histo_NN <- ggplot(NN_PC1_surveys, aes(x = NN_PC1)) +
  geom_histogram( bins = 60, aes(fill=..x..), color="grey50", size=0.3)+
  scale_fill_gradient2(low = "black", mid = "white", high = "forestgreen", guide = "colourbar")+
  labs(x = "Nature for nature PC1 site's evaluation")+
  geom_vline(xintercept = 0, linetype = 2, col= "black")+
  theme_minimal()
histo_NN
```

### Nature contributions to Society

```{r, echo=FALSE, warning=FALSE}
NS <- names(grp)[ grp=="NS" ]
#NS <- NS[1:8] # enlever fishery biomass ################################
NCP_NS <- NCP_site[,NS]
rownames(NCP_NS) <- rownames(NCP_site)

pca <- FactoMineR::PCA(NCP_NS, scale.unit = T, graph=F, ncp=10)

factoextra::fviz_eig(pca, addlabels = TRUE, ylim = c(0, 35), barfill = "dodgerblue3", barcolor = "dodgerblue3")

var <- get_pca_var(pca)
corrplot(var$contrib, is.corr=FALSE)
```

#### Nature for Society variations in the 2 first dimensions 

```{r, echo=TRUE, fig.height=9, fig.width=9}
fviz_pca_var(pca, col.var = "dodgerblue3",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE
)
```

#### NS PCA in dimensions 3 and 4 *(for variables with cos2 \> 0.1)*

```{r, echo=FALSE, fig.height=7, fig.width=7}
fviz_pca_var(pca, col.var = "cos2",
             axe=c(3,4),
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE,
             select.var = list(cos2 = 0.1)
)
```

#### Surveys positions in PC1

```{r}
NS_PC1_surveys <- pca$ind$coord[,1]
summary(NS_PC1_surveys)
```

```{r, echo=FALSE}
NN_NS_PC1_surveys <- data.frame(SiteCode = NCP_site$SiteCode ,
                                NN_PC1=NN_PC1_surveys,
                                NS_PC1=NS_PC1_surveys)
rownames(NN_NS_PC1_surveys) <- rownames(NCP_site)

##NS
histo_NS <- ggplot(NN_NS_PC1_surveys, aes(x = NS_PC1)) +
  geom_histogram( bins = 60, aes(fill=..x..), color="grey30", size=0.3)+
  scale_fill_gradient2(low = "black", mid = "white", high = "dodgerblue3", guide = "colourbar")+
  labs(x = "Nature to People PC1 site's evaluation")+
  geom_vline(xintercept = 0, linetype = 2, col= "black")+
  theme_minimal()
histo_NS

```

## NN against NS

```{r, warning=FALSE, message=FALSE}
##NS~NN
#Define colors by quarter

#up right
quarter_up_right <- NN_NS_PC1_surveys |>
  filter(NN_PC1 > 0 & NS_PC1 > 0) |>
  mutate(product_u_r =  pnorm(NN_PC1 * NS_PC1) )

pal <- grDevices::colorRampPalette(c("white", "darkred")) (nrow(quarter_up_right))

quarter_up_right <- quarter_up_right |>
  dplyr::arrange(product_u_r) |>
  dplyr::mutate( cols = pal)

#up left
quarter_up_left <- NN_NS_PC1_surveys |>
  filter(NN_PC1 < 0 & NS_PC1 > 0) |>
  mutate(product_u_l =  pnorm(-NN_PC1 * NS_PC1) )

pal <- grDevices::colorRampPalette(c("white", "dodgerblue3")) (nrow(quarter_up_left))

quarter_up_left <- quarter_up_left |>
  dplyr::arrange(product_u_l) |>
  dplyr::mutate( cols = pal)

#down right
quarter_down_right <- NN_NS_PC1_surveys |>
  filter(NN_PC1 > 0 & NS_PC1 < 0) |>
  mutate(product_d_r =  pnorm(NN_PC1 * -NS_PC1))

pal <- grDevices::colorRampPalette(c("white", "forestgreen")) (nrow(quarter_down_right))

quarter_down_right <- quarter_down_right |>
  dplyr::arrange(product_d_r) |>
  dplyr::mutate( cols = pal)

#down left
quarter_down_left <- NN_NS_PC1_surveys |>
  filter(NN_PC1 < 0 & NS_PC1 < 0) |>
  mutate(product_d_l =  pnorm(NN_PC1 * NS_PC1))

pal <- grDevices::colorRampPalette(c("white", "grey20")) (nrow(quarter_down_left))

quarter_down_left <- quarter_down_left |>
  dplyr::arrange(product_d_l) |>
  dplyr::mutate( cols = pal)


#Merge the 4 quarters
NN_NS_with_col <- quarter_down_left |>
  full_join(quarter_down_right) |>
  full_join(quarter_up_left) |>
  full_join(quarter_up_right)



library(ggplot2)
NN_NS_plot <- ggplot(NN_NS_with_col, aes( y= NS_PC1, x = NN_PC1) ) +
  #up right quarter
  geom_point(data= dplyr::filter(NN_NS_with_col, is.na(product_u_r)==F),
             size = 2,
             aes(colour= product_u_r, alpha = product_u_r)) +
  scale_colour_gradient("product_u_r",
                        low = "white", high="darkred",
                        na.value=NA) +

  ggnewscale::new_scale("colour") +

  #up left quarter
  geom_point(data= dplyr::filter(NN_NS_with_col, is.na(product_u_l)==F),
             size = 2,
             aes(colour=product_u_l, alpha = product_u_l)) +
  scale_colour_gradient("product_u_l",
                        low = "white", high="dodgerblue3",
                        na.value=NA) +
  geom_point(aes( y= NS_PC1, x = NN_PC1),
            shape = 1, size = 2, stroke = 1,
            color= "black",
            data = filter(NN_NS_with_col ,
                             product_u_l > quantile(NN_NS_with_col$product_u_l, 0.97, na.rm = TRUE))) +


  ggnewscale::new_scale("colour") +

  #down right quarter
  geom_point(data= dplyr::filter(NN_NS_with_col, is.na(product_d_r)==F),
             size = 2,
             aes(colour=product_d_r, alpha = product_d_r)) +
  scale_colour_gradient("product_d_r",
                        low = "white", high="forestgreen",
                        na.value=NA) +
  geom_point(aes( y= NS_PC1, x = NN_PC1),
            shape = 1, size = 2, stroke = 1,
            color= "black",
            data = head(NN_NS_with_col[order(NN_NS_with_col$product_d_r, decreasing = T),], 15)) +

  ggnewscale::new_scale("colour") +

  #down left quarter
  geom_point(data= dplyr::filter(NN_NS_with_col, is.na(product_d_l)==F),
             size = 2,
             aes(colour= product_d_l, alpha = product_d_l)) +
  scale_colour_gradient("product_d_l",
                        low = "white", high="grey20",
                        na.value=NA) +

  scale_alpha_continuous(range = c(0, 0.8)) +


  #add lines
  geom_vline(xintercept = 0, linetype = 2, col = "black")+
  geom_hline(yintercept = 0, linetype = 2, col = "black")+
  labs( x=  "Nature to Nature", y = "Nature to People")+
  theme_minimal()+
  theme(legend.position = "none")

NN_NS_plot
#ggsave( here::here("outputs", "figures", "Sites in NN and NS PC1.jpg"), plot = NN_NS_plot, width=20, height = 15 )

#plot(NN_NS_with_col$NN_PC1, NN_NS_with_col$NS_PC1, col=NN_NS_with_col$cols, pch=19)

```

## Plot on map

### NS according to NN

```{r, eval=TRUE,echo=FALSE, warning=FALSE, message=FALSE, fig.height=7, fig.width=15}
#world coast shapefile
coast <- sf::st_read(here::here("data", "ShapeFiles coast", "GSHHS_h_L1.shp"))
#data
NN_NS_with_col <- NN_NS_with_col %>%  left_join(NCP_site[,c("SiteCode", "SiteLongitude", "SiteLatitude")])
#plot
map <- ggplot(NN_NS_with_col) +
  geom_sf(data = coast, color = NA, fill = "lightgrey") +

  #down left quarter
  geom_point(data= dplyr::filter(NN_NS_with_col, is.na(product_d_l)==F),
             size = 2, alpha = 0.5,
             aes(x = SiteLongitude, y = SiteLatitude,
                 colour= product_d_l, alpha = product_d_l)) +
  scale_colour_gradient("product_d_l",
                        low = "white", high="grey20",
                        na.value=NA) +
  ggnewscale::new_scale("colour") +

  #up left quarter
  geom_point(data= dplyr::filter(NN_NS_with_col, is.na(product_u_l)==F),
             size = 2, alpha = 0.5,
             aes(x = SiteLongitude, y = SiteLatitude,
                 colour=product_u_l, alpha = product_u_l)) +
  scale_colour_gradient("product_u_l",
                        low = "white", high="dodgerblue3",
                        na.value=NA) +
  geom_point(aes(x = SiteLongitude, y = SiteLatitude),
            shape = 1, size = 2, stroke = 1,
            color= "black",
            data = head(NN_NS_with_col[order(NN_NS_with_col$product_d_r, decreasing = T),], 8)) +

  ggnewscale::new_scale("colour") +

  #down right quarter
  geom_point(data= dplyr::filter(NN_NS_with_col, is.na(product_d_r)==F),
             size = 2, alpha = 0.5,
             aes(x = SiteLongitude, y = SiteLatitude,
                 colour=product_d_r, alpha = product_d_r)) +
  scale_colour_gradient("product_d_r",
                        low = "white", high="forestgreen",
                        na.value=NA) +
  geom_point(aes(x = SiteLongitude, y = SiteLatitude),
            shape = 1, size = 2, stroke = 1,
            color= "black",
            data = filter(NN_NS_with_col ,
                             product_d_r >= quantile(NN_NS_with_col$product_d_r, 0.95, na.rm = TRUE))) +

  ggnewscale::new_scale("colour") +

    #up right quarter
  geom_point(data= dplyr::filter(NN_NS_with_col, is.na(product_u_r)==F),
             size = 2,
             aes(x = SiteLongitude, y = SiteLatitude,
                 colour= product_u_r, alpha = product_u_r)) +
  scale_colour_gradient("product_u_r",
                        low = "white", high="darkred",
                        na.value=NA) +
  #add transparency
  scale_alpha_continuous(range = c(0, 1)) +


  coord_sf(ylim = c(-36, 31), expand = FALSE) +
  guides(color = guide_legend(override.aes = list(size = 3, alpha = 1))) +
  scale_size_continuous(range = c(0.5, 4), guide = FALSE) +
  theme_minimal()+
  labs(title = "Trade-offs in Nature Based Contribution worldwide",
       x="Longitude", y= "Latitude") +
  theme(legend.position = "none",
        plot.title = element_text(size=10, face="bold"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        plot.margin = unit(c(0.000,0.000,0.000,0.000), units = , "cm")
        )
#ggsave( here::here("outputs", "figures", "world map with NN and NS PC1.jpg"), plot = map, width=15, height = 7 )
map
```

### NN worldwide

```{r,echo=FALSE, warning=FALSE, message=FALSE,fig.height=7, fig.width=15}
##NN
map <- ggplot(NN_NS_with_col) +
  geom_sf(data = coast, color = NA, fill = "lightgrey") +
  geom_point(aes(x = SiteLongitude, y = SiteLatitude,
                 color = NN_PC1, alpha= abs(NN_PC1),
                 size = 2)) +
    geom_point(aes(x = SiteLongitude, y = SiteLatitude),
            shape = 1, size = 2, stroke = 0.5,
            color= "black",
            data = head(NN_NS_with_col[order(NN_NS_with_col$product_d_r, decreasing = T),], 15)) +
  
  scale_colour_gradientn(colours = colorRampPalette(rev(c( "forestgreen","white", "grey30")))(1000)) +
  scale_alpha_continuous(range = c(0, 1)) +

  coord_sf(ylim = c(-36, 31), expand = FALSE) +
  guides(color = guide_legend(override.aes = list(size = 3, alpha = 1))) +
  scale_size_continuous(range = c(0.5, 4), guide = FALSE) +
  theme_minimal()+
  labs(title = "Nature for Nature",
       x="Longitude", y= "Latitude") +
  theme(
        plot.title = element_text(size=10, face="bold"),
        )
map
```

### NS worldwide

```{r,echo=FALSE, warning=FALSE,fig.height=7, fig.width=15}
##NS
map <- ggplot(NN_NS_with_col) +
  geom_sf(data = coast, color = NA, fill = "lightgrey") +
  geom_point(aes(x = SiteLongitude, y = SiteLatitude,
                 color = NS_PC1, alpha= abs(NS_PC1),
                 size = 2)) +
  geom_point(aes(x = SiteLongitude, y = SiteLatitude),
            shape = 1, size = 2, stroke = 1,
            color= "black",
            data = filter(NN_NS_with_col ,
                             NN_PC1 >= quantile(NN_PC1, 0.99, na.rm = TRUE))) +

  scale_colour_gradientn(colours = colorRampPalette(rev(c( "dodgerblue3","white", "grey30")))(1000)) +
  scale_alpha_continuous(range = c(0, 1)) +

  coord_sf(ylim = c(-36, 31), expand = FALSE) +
  scale_size_continuous(range = c(0.5, 4), guide = FALSE) +
  theme_minimal()+
  labs(title = "Nature to People",
       x="Longitude", y= "Latitude") +
  theme(
        plot.title = element_text(size=10, face="bold"),
        )

map
```


# RDA

Hierarchical and Variation Partitioning for Canonical Analysis Without Limiting the Number of Predictors (Matrices) is a statistical technique used to identify the relative importance of a set of predictors (matrices) on a dependent variable. Hierarchical and Variation Partitioning for Canonical Analysis Without Limiting the Number of Predictors (Matrices) starts with a correlation matrix of all the predictors and the dependent variable. The correlation matrix is then partitioned into two parts. The first partition is a hierarchical structure and the second partition is a variation structure. The hierarchical partition is used to identify which predictors are more closely related to the dependent variable and the variation partition is used to identify which predictors have more variation among them. This technique can be used to identify and rank the relative importance of predictors without limiting the number of predictors.

Permutation Test of Hierarchical Partitioning for Canonical Analysis is a statistical technique used to determine if the hierarchical partitioning of the correlation matrix of all the predictors and the dependent variable is statistically significant. The permutation test calculates the probability that the hierarchical partitioning of the correlation matrix is due to chance. If the probability is below a certain threshold, then the results of the hierarchical partitioning can be regarded as statistically significant. This technique is useful in determining which predictors are more closely related to the dependent variable and helps to identify and rank the relative importance of predictors without limiting the number of predictors.

